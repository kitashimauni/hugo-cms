<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hugo Home CMS</title>
    <style>
        /* „Çπ„Éû„ÉõÂêë„Åë„É™„Çª„ÉÉ„Éà & „É¨„Ç§„Ç¢„Ç¶„Éà */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #222; color: #ddd; }
        
        /* „É°„Ç§„É≥„Ç®„É™„Ç¢ */
        #main-container { flex: 1; overflow: hidden; position: relative; }
        .tab-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; background: #1e1e1e; overflow-y: auto; }
        .tab-content.active { display: block; }

        /* File List Styles */
        .file-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; }
        .file-item:hover { background: #333; }

        /* Editor Styles */
        #edit-container { display: flex; flex-direction: column; height: 100%; }
        #fm-container { background: #252526; padding: 10px; border-bottom: 1px solid #333; max-height: 40%; overflow-y: auto; }
        #editor-wrapper { flex: 1; position: relative; }
        textarea { width: 100%; height: 100%; background: #1e1e1e; color: #f8f8f2; border: none; padding: 10px; font-family: monospace; font-size: 16px; box-sizing: border-box; resize: none; outline: none; }

        /* Form Styles */
        .fm-field { margin-bottom: 10px; }
        .fm-label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
        .fm-input { width: 100%; background: #333; color: white; border: 1px solid #444; padding: 6px; border-radius: 4px; box-sizing: border-box; }
        .fm-input:focus { border-color: #007acc; outline: none; }
        .fm-checkbox { margin-right: 5px; }

        /* Preview Styles */
        iframe { width: 100%; height: 100%; border: none; background: white; }

        /* Bottom Navigation */
        nav { height: 60px; background: #333; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #444; }
        nav button { background: none; border: none; color: #888; font-size: 14px; font-weight: bold; flex: 1; height: 100%; cursor: pointer; }
        nav button.active { color: #fff; background: #444; }

        /* Header (Save/Build buttons) */
        header { height: 50px; background: #252526; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid #333; }
        #filename-display { font-size: 12px; color: #aaa; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        .action-btn { background: #007acc; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 14px; margin-left: 5px; }
        .action-btn:disabled { background: #555; }
    </style>
</head>
<body>

    <header>
        <div id="filename-display" style="flex:1;">Select a file...</div>
        <div style="display:flex; gap:5px;">
            <button class="action-btn" onclick="saveFile()">Save</button>
            <button class="action-btn" style="background:#2da44e;" onclick="runBuild()">Preview</button>
            <button class="action-btn" style="background:#d73a49; font-weight:bold;" onclick="runPublish()">Publish</button>
        </div>
    </header>

    <div id="main-container">
        <div id="tab-files" class="tab-content active">
            <div style="padding:10px; border-bottom:1px solid #444; text-align:right;">
                <button class="action-btn" style="background:#666;" onclick="runSync()">üîÑ Sync form GitHub</button>
            </div>
            <div id="file-list">Loading...</div>
        </div>

        <div id="tab-edit" class="tab-content">
            <div id="edit-container">
                <div id="fm-container" style="display:none;"></div>
                <div id="editor-wrapper">
                    <textarea id="editor" placeholder="Select a file to edit..."></textarea>
                </div>
            </div>
        </div>

        <div id="tab-preview" class="tab-content">
            <iframe id="preview-frame" src=""></iframe>
        </div>
    </div>

    <nav>
        <button onclick="switchTab('files', this)" class="active">Files</button>
        <button onclick="switchTab('edit', this)">Edit</button>
        <button onclick="switchTab('preview', this)">Preview</button>
    </nav>

    <script>
        let currentPath = "";
        let currentData = null; // Store current loaded data for FM structure

        // ÂàùÊúüÂåñ: Ë®ò‰∫ã‰∏ÄË¶ß„ÇíÂèñÂæó
        fetchFiles();

        function switchTab(tabName, btn) {
            // „Çø„ÉñÂàá„ÇäÊõø„ÅàË°®Á§∫
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ
            if(btn) {
                document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }
        }

        async function fetchFiles() {
            const res = await fetch('/api/articles');
            if (res.status === 401) {
                window.location.href = "/login";
                return;
            }
            const files = await res.json();
            const list = document.getElementById('file-list');
            list.innerHTML = "";
            
            files.forEach(f => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.textContent = f.path; // + " (" + f.title + ")";
                div.onclick = () => loadFile(f.path);
                list.appendChild(div);
            });
        }

        async function loadFile(path) {
            currentPath = path;
            document.getElementById('filename-display').textContent = path;
            
            const res = await fetch(`/api/article?path=${path}`);
            const data = await res.json();
            currentData = data;
            
            const fmContainer = document.getElementById('fm-container');
            const editor = document.getElementById('editor');

            if (data.frontmatter) {
                // Structured mode
                renderFrontMatterForm(data.frontmatter);
                fmContainer.style.display = 'block';
                editor.value = data.body;
            } else {
                // Raw mode
                fmContainer.style.display = 'none';
                fmContainer.innerHTML = '';
                editor.value = data.content;
            }
            
            // „Ç®„Éá„Ç£„Çø„Çø„Éñ„Å∏Ëá™ÂãïÁßªÂãï
            switchTab('edit', document.querySelectorAll('nav button')[1]);
        }

        function renderFrontMatterForm(fm) {
            const container = document.getElementById('fm-container');
            container.innerHTML = '<div style="color:#aaa; font-weight:bold; margin-bottom:10px;">Front Matter</div>';
            
            for (const [key, value] of Object.entries(fm)) {
                const div = document.createElement('div');
                div.className = 'fm-field';
                
                const label = document.createElement('label');
                label.className = 'fm-label';
                label.textContent = key;
                div.appendChild(label);

                if (typeof value === 'boolean') {
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'fm-checkbox';
                    input.checked = value;
                    input.dataset.key = key;
                    input.dataset.type = 'boolean';
                    
                    // Checkbox label wrap
                    const wrapper = document.createElement('label');
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'center';
                    wrapper.appendChild(input);
                    wrapper.appendChild(document.createTextNode(value ? ' True' : ' False'));
                    
                    // Toggle label text on change
                    input.onchange = (e) => {
                         wrapper.lastChild.textContent = e.target.checked ? ' True' : ' False';
                    };

                    div.appendChild(wrapper);

                } else if (Array.isArray(value)) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'fm-input';
                    input.value = value.join(', '); // Simple CSV for now
                    input.dataset.key = key;
                    input.dataset.type = 'array';
                    div.appendChild(input);
                } else {
                    // String, Number, etc.
                    const input = document.createElement('input');
                    input.type = 'text'; // Default to text
                    input.className = 'fm-input';
                    input.value = value === null ? '' : value;
                    input.dataset.key = key;
                    input.dataset.type = typeof value; // string or number
                    div.appendChild(input);
                }
                
                container.appendChild(div);
            }
        }

        function collectFrontMatter() {
            if (!currentData || !currentData.frontmatter) return null;
            
            const fm = {};
            const inputs = document.querySelectorAll('#fm-container input');
            
            inputs.forEach(input => {
                const key = input.dataset.key;
                const type = input.dataset.type;
                
                if (type === 'boolean') {
                    fm[key] = input.checked;
                } else if (type === 'array') {
                    // Split by comma and trim
                    const val = input.value.trim();
                    if (val === "") {
                         fm[key] = [];
                    } else {
                         fm[key] = val.split(',').map(s => s.trim());
                    }
                } else if (type === 'number') {
                    const num = Number(input.value);
                    fm[key] = isNaN(num) ? input.value : num;
                } else {
                    fm[key] = input.value;
                }
            });
            return fm;
        }

        async function saveFile() {
            if(!currentPath) return alert("No file selected");
            
            const btn = document.querySelector('button[onclick="saveFile()"]');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";

            const payload = {
                path: currentPath,
            };

            const fm = collectFrontMatter();
            if (fm) {
                payload.frontmatter = fm;
                payload.body = document.getElementById('editor').value;
                payload.format = currentData.format || 'yaml';
            } else {
                payload.content = document.getElementById('editor').value;
            }

            await fetch('/api/article', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            btn.textContent = originalText;
            // alert("Saved!"); 
        }

        async function runBuild() {
            const btn = document.querySelector('button[onclick="runBuild()"]');
            btn.textContent = "Building...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/build', { method: 'POST' });
                const data = await res.json();
                
                if (data.status === 'ok') {
                    // „Éó„É¨„Éì„É•„Éº„Çø„Éñ„Å∏ÁßªÂãï„Åó„Å¶„É™„É≠„Éº„Éâ
                    const frame = document.getElementById('preview-frame');
                    // „Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„Çí„Å§„Åë„Å¶„É™„É≠„Éº„Éâ
                    frame.src = "/preview/index.html?t=" + Date.now();
                    switchTab('preview', document.querySelectorAll('nav button')[2]);
                } else {
                    alert("Build Error:\n" + data.log);
                }
            } catch(e) {
                alert("Network Error");
            } finally {
                btn.textContent = "Build";
                btn.disabled = false;
            }
        }

        async function runSync() {
            if(!confirm("GitHub„Åã„ÇâÊúÄÊñ∞„ÅÆÁä∂ÊÖã„ÇíÂèñÂæó„Åó„Åæ„Åô„ÅãÔºü\nÔºà„É≠„Éº„Ç´„É´„ÅÆÊú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„ÅØÊ≥®ÊÑè„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ")) return;
            
            const btn = document.querySelector('button[onclick="runSync()"]');
            const originalText = btn.textContent;
            btn.textContent = "Syncing...";
            
            try {
                const res = await fetch('/api/sync', { method: 'POST' });
                const data = await res.json();
                if(data.status === 'ok') {
                    alert("Sync Complete!\n" + data.log);
                    fetchFiles(); // „É™„Çπ„ÉàÊõ¥Êñ∞
                } else {
                    alert("Sync Error:\n" + data.log);
                }
            } catch(e) {
                alert("Network Error");
            } finally {
                btn.textContent = originalText;
            }
        }

        async function runPublish() {
            if(!confirm("„Åì„ÅÆË®ò‰∫ã„ÅÆÂ§âÊõ¥„ÇíGitHub„Å´Push„Åó„Å¶ÂÖ¨Èñã„Åó„Åæ„Åô„ÅãÔºü")) return;

            const btn = document.querySelector('button[onclick="runPublish()"]');
            btn.textContent = "Pushing...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/publish', { method: 'POST' });
                const data = await res.json();
                if(data.status === 'ok') {
                    alert("Published Successfully! üöÄ\nCloudflare Pages will deploy shortly.");
                } else {
                    alert("Publish Error:\n" + data.log);
                }
            } catch(e) {
                alert("Network Error");
            } finally {
                btn.textContent = "Publish";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>