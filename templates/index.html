<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hugo Home CMS</title>
    <style>
        /* ã‚¹ãƒãƒ›å‘ã‘ãƒªã‚»ãƒƒãƒˆ & ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #222; color: #ddd; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        #main-container { flex: 1; overflow: hidden; position: relative; }
        .tab-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; background: #1e1e1e; overflow-y: auto; }
        .tab-content.active { display: block; }

        /* File List Styles */
        .file-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; }
        .file-item:hover { background: #333; }

        /* Editor Styles */
        textarea { width: 100%; height: 100%; background: #1e1e1e; color: #f8f8f2; border: none; padding: 10px; font-family: monospace; font-size: 16px; box-sizing: border-box; resize: none; outline: none; }

        /* Preview Styles */
        iframe { width: 100%; height: 100%; border: none; background: white; }

        /* Bottom Navigation */
        nav { height: 60px; background: #333; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #444; }
        nav button { background: none; border: none; color: #888; font-size: 14px; font-weight: bold; flex: 1; height: 100%; cursor: pointer; }
        nav button.active { color: #fff; background: #444; }

        /* Header (Save/Build buttons) */
        header { height: 50px; background: #252526; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid #333; }
        #filename-display { font-size: 12px; color: #aaa; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        .action-btn { background: #007acc; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 14px; margin-left: 5px; }
        .action-btn:disabled { background: #555; }
    </style>
</head>
<body>

    <header>
        <div id="filename-display" style="flex:1;">Select a file...</div>
        <div style="display:flex; gap:5px;">
            <button class="action-btn" onclick="saveFile()">Save</button>
            <button class="action-btn" style="background:#2da44e;" onclick="runBuild()">Preview</button>
            <button class="action-btn" style="background:#d73a49; font-weight:bold;" onclick="runPublish()">Publish</button>
        </div>
    </header>

    <div id="main-container">
        <div id="tab-files" class="tab-content active">
            <div style="padding:10px; border-bottom:1px solid #444; text-align:right;">
                <button class="action-btn" style="background:#666;" onclick="runSync()">ğŸ”„ Sync form GitHub</button>
            </div>
            <div id="file-list">Loading...</div>
        </div>

        <div id="tab-edit" class="tab-content">
            <textarea id="editor" placeholder="Select a file to edit..."></textarea>
        </div>

        <div id="tab-preview" class="tab-content">
            <iframe id="preview-frame" src=""></iframe>
        </div>
    </div>

    <nav>
        <button onclick="switchTab('files', this)" class="active">Files</button>
        <button onclick="switchTab('edit', this)">Edit</button>
        <button onclick="switchTab('preview', this)">Preview</button>
    </nav>

    <script>
        let currentPath = "";

        // åˆæœŸåŒ–: è¨˜äº‹ä¸€è¦§ã‚’å–å¾—
        fetchFiles();

        function switchTab(tabName, btn) {
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆè¡¨ç¤º
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            if(btn) {
                document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }
        }

        async function fetchFiles() {
            const res = await fetch('/api/articles');
            if (res.status === 401) {
                window.location.href = "/login";
                return;
            }
            const files = await res.json();
            const list = document.getElementById('file-list');
            list.innerHTML = "";
            
            files.forEach(f => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.textContent = f.path; // + " (" + f.title + ")";
                div.onclick = () => loadFile(f.path);
                list.appendChild(div);
            });
        }

        async function loadFile(path) {
            currentPath = path;
            document.getElementById('filename-display').textContent = path;
            
            const res = await fetch(`/api/article?path=${path}`);
            const data = await res.json();
            
            document.getElementById('editor').value = data.content;
            
            // ã‚¨ãƒ‡ã‚£ã‚¿ã‚¿ãƒ–ã¸è‡ªå‹•ç§»å‹•
            switchTab('edit', document.querySelectorAll('nav button')[1]);
        }

        async function saveFile() {
            if(!currentPath) return alert("No file selected");
            
            const content = document.getElementById('editor').value;
            const btn = document.querySelector('button[onclick="saveFile()"]');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";

            await fetch('/api/article', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ path: currentPath, content: content })
            });
            
            btn.textContent = originalText;
            // alert("Saved!"); // é‚ªé­”ãªã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆå¥½ã¿ã«å¿œã˜ã¦ï¼‰
        }

        async function runBuild() {
            const btn = document.querySelector('button[onclick="runBuild()"]');
            btn.textContent = "Building...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/build', { method: 'POST' });
                const data = await res.json();
                
                if (data.status === 'ok') {
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã¸ç§»å‹•ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
                    const frame = document.getElementById('preview-frame');
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã‚’ã¤ã‘ã¦ãƒªãƒ­ãƒ¼ãƒ‰
                    frame.src = "/preview/index.html?t=" + Date.now();
                    switchTab('preview', document.querySelectorAll('nav button')[2]);
                } else {
                    alert("Build Error:\n" + data.log);
                }
            } catch(e) {
                alert("Network Error");
            } finally {
                btn.textContent = "Build";
                btn.disabled = false;
            }
        }

        async function runSync() {
            if(!confirm("GitHubã‹ã‚‰æœ€æ–°ã®çŠ¶æ…‹ã‚’å–å¾—ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®æœªä¿å­˜ã®å¤‰æ›´ã¯æ³¨æ„ã—ã¦ãã ã•ã„ï¼‰")) return;
            
            const btn = document.querySelector('button[onclick="runSync()"]');
            const originalText = btn.textContent;
            btn.textContent = "Syncing...";
            
            try {
                const res = await fetch('/api/sync', { method: 'POST' });
                const data = await res.json();
                if(data.status === 'ok') {
                    alert("Sync Complete!\n" + data.log);
                    fetchFiles(); // ãƒªã‚¹ãƒˆæ›´æ–°
                } else {
                    alert("Sync Error:\n" + data.log);
                }
            } catch(e) {
                alert("Network Error");
            } finally {
                btn.textContent = originalText;
            }
        }

        async function runPublish() {
            if(!confirm("ã“ã®è¨˜äº‹ã®å¤‰æ›´ã‚’GitHubã«Pushã—ã¦å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ")) return;

            const btn = document.querySelector('button[onclick="runPublish()"]');
            btn.textContent = "Pushing...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/publish', { method: 'POST' });
                const data = await res.json();
                if(data.status === 'ok') {
                    alert("Published Successfully! ğŸš€\nCloudflare Pages will deploy shortly.");
                } else {
                    alert("Publish Error:\n" + data.log);
                }
            } catch(e) {
                alert("Network Error");
            } finally {
                btn.textContent = "Publish";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>