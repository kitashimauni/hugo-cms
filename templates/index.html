<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hugo Home CMS</title>
    <style>
        /* „Çπ„Éû„ÉõÂêë„Åë„É™„Çª„ÉÉ„Éà & „É¨„Ç§„Ç¢„Ç¶„Éà */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #222; color: #ddd; }
        
        /* „É°„Ç§„É≥„Ç®„É™„Ç¢ */
        #main-container { flex: 1; overflow: hidden; position: relative; }
        .tab-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; background: #1e1e1e; overflow-y: auto; }
        .tab-content.active { display: block; }

        /* File List Styles */
        .file-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; }
        .file-item:hover { background: #333; }

        /* Editor Styles */
        #edit-container { display: flex; flex-direction: column; height: 100%; }
        #fm-container { background: #252526; padding: 10px; border-bottom: 1px solid #333; max-height: 40%; overflow-y: auto; }
        #editor-wrapper { flex: 1; position: relative; }
        textarea { width: 100%; height: 100%; background: #1e1e1e; color: #f8f8f2; border: none; padding: 10px; font-family: monospace; font-size: 16px; box-sizing: border-box; resize: none; outline: none; }

        /* Form Styles */
        .fm-field { margin-bottom: 10px; }
        .fm-label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
        .fm-input { width: 100%; background: #333; color: white; border: 1px solid #444; padding: 6px; border-radius: 4px; box-sizing: border-box; }
        .fm-input:focus { border-color: #007acc; outline: none; }
        .fm-checkbox { margin-right: 5px; }
        .fm-help { font-size: 11px; color: #666; margin-top: 2px; }

        /* Preview Styles */
        iframe { width: 100%; height: 100%; border: none; background: white; }

        /* Bottom Navigation */
        nav { height: 60px; background: #333; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #444; }
        nav button { background: none; border: none; color: #888; font-size: 14px; font-weight: bold; flex: 1; height: 100%; cursor: pointer; }
        nav button.active { color: #fff; background: #444; }

        /* Header (Save/Build buttons) */
        header { height: 50px; background: #252526; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid #333; }
        #filename-display { font-size: 12px; color: #aaa; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        .action-btn { background: #007acc; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 14px; margin-left: 5px; cursor: pointer; }
        .action-btn:disabled { background: #555; }
        
        /* Modal */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        #modal-box { background: #252526; width: 90%; max-width: 800px; max-height: 90%; display: flex; flex-direction: column; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #modal-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #modal-body { padding: 15px; overflow: auto; font-family: monospace; white-space: pre-wrap; background: #1e1e1e; color: #ccc; flex: 1; }
        .diff-added { color: #81b181; }
        .diff-removed { color: #d67a7a; }
    </style>
</head>
<body>

    <header>
        <div id="filename-display" style="flex:1;">Select a file...</div>
        <div style="display:flex; gap:5px;">
            <button class="action-btn" style="background:#555;" onclick="resetChanges()">Reset</button>
            <button class="action-btn" style="background:#888;" onclick="showDiff()">Diff</button>
            <button class="action-btn" onclick="saveFile()">Save</button>
            <button class="action-btn" style="background:#2da44e;" onclick="runBuild()">Preview</button>
            <button class="action-btn" style="background:#d73a49; font-weight:bold;" onclick="runPublish()">Publish</button>
        </div>
    </header>

    <div id="main-container">
        <div id="tab-files" class="tab-content active">
            <div style="padding:10px; border-bottom:1px solid #444; display:flex; justify-content:flex-end; gap:10px;">
                <button class="action-btn" style="background:#2da44e;" onclick="createNewFile()">+ New File</button>
                <button class="action-btn" style="background:#666;" onclick="runSync()">üîÑ Sync form GitHub</button>
            </div>
            <div id="file-list">Loading...</div>
        </div>

        <div id="tab-edit" class="tab-content">
            <div id="edit-container">
                <div id="fm-container" style="display:none;"></div>
                <div id="editor-wrapper">
                    <textarea id="editor" placeholder="Select a file to edit..."></textarea>
                </div>
            </div>
        </div>

        <div id="tab-preview" class="tab-content">
            <iframe id="preview-frame" src=""></iframe>
        </div>
    </div>

    <nav>
        <button onclick="switchTab('files', this)" class="active">Files</button>
        <button onclick="switchTab('edit', this)">Edit</button>
        <button onclick="switchTab('preview', this)">Preview</button>
    </nav>

    <!-- Modal -->
    <div id="modal-overlay">
        <div id="modal-box">
            <div id="modal-header">
                <span style="font-weight:bold;">Diff</span>
                <button class="action-btn" style="background:#444;" onclick="closeModal()">Close</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        let currentPath = "";
        let currentData = null; 
        let cmsConfig = null;

        // ÂàùÊúüÂåñ
        init();

        async function init() {
            await fetchConfig();
            await fetchFiles();
        }

        async function fetchConfig() {
            try {
                const res = await fetch('/api/config');
                if (res.ok) {
                    cmsConfig = await res.json();
                } else {
                    console.warn("Config not found or invalid");
                }
            } catch(e) {
                console.error("Failed to fetch config", e);
            }
        }

        function switchTab(tabName, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            if(btn) {
                document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }
        }

        async function fetchFiles() {
            const res = await fetch('/api/articles');
            if (res.status === 401) {
                window.location.href = "/login";
                return;
            }
            const files = await res.json();
            const list = document.getElementById('file-list');
            list.innerHTML = "";

            const grouped = {};
            const others = [];

            if (cmsConfig && cmsConfig.collections) {
                cmsConfig.collections.forEach(col => {
                    grouped[col.name] = { label: col.label, files: [] };
                });
            }

            files.forEach(f => {
                let matched = false;
                if (cmsConfig && cmsConfig.collections) {
                    for (const col of cmsConfig.collections) {
                        const colFolder = col.folder.replace(/^content\//, '');
                        if (f.path.startsWith(colFolder + "/") || f.path === colFolder) {
                            grouped[col.name].files.push(f);
                            matched = true;
                            break;
                        }
                    }
                }
                if (!matched) {
                    others.push(f);
                }
            });

            if (cmsConfig && cmsConfig.collections) {
                cmsConfig.collections.forEach(col => {
                    const group = grouped[col.name];
                    if (group.files.length > 0) {
                        renderCollectionGroup(list, group.label, group.files);
                    }
                });
            }

            if (others.length > 0) {
                renderCollectionGroup(list, "Others", others);
            }
        }

        function renderCollectionGroup(container, label, files) {
            const details = document.createElement('details');
            details.open = true;
            details.style.marginBottom = '10px';
            
            const summary = document.createElement('summary');
            summary.textContent = label;
            summary.style.cursor = 'pointer';
            summary.style.padding = '10px';
            summary.style.background = '#333';
            summary.style.color = '#fff';
            summary.style.fontWeight = 'bold';
            summary.style.borderBottom = '1px solid #444';
            
            details.appendChild(summary);

            files.forEach(f => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.style.paddingLeft = '20px'; 
                
                const titleDiv = document.createElement('div');
                titleDiv.style.fontWeight = 'bold';
                
                let titleText = f.title || f.path;
                if (f.is_dirty) {
                    titleText = "‚úé " + titleText;
                    titleDiv.style.color = "#e2c08d"; // Modified color
                }
                titleDiv.textContent = titleText;
                
                const pathDiv = document.createElement('div');
                pathDiv.style.fontSize = '12px';
                pathDiv.style.color = '#888';
                pathDiv.textContent = f.path;

                div.appendChild(titleDiv);
                div.appendChild(pathDiv);
                
                div.onclick = () => loadFile(f.path);
                details.appendChild(div);
            });

            container.appendChild(details);
        }

        async function loadFile(path) {
            currentPath = path;
            document.getElementById('filename-display').textContent = path;
            
            const res = await fetch(`/api/article?path=${path}`);
            const data = await res.json();
            currentData = data;
            
            const fmContainer = document.getElementById('fm-container');
            const editor = document.getElementById('editor');

            if (data.frontmatter) {
                renderFrontMatterForm(data.frontmatter, path);
                fmContainer.style.display = 'block';
                editor.value = data.body;
            } else {
                fmContainer.style.display = 'none';
                fmContainer.innerHTML = '';
                editor.value = data.content;
            }
            
            switchTab('edit', document.querySelectorAll('nav button')[1]);
        }

        function getCollectionForPath(path) {
            if (!cmsConfig || !cmsConfig.collections) return null;
            for (const col of cmsConfig.collections) {
                const colFolder = col.folder.replace(/^content\//, '');
                if (path.startsWith(colFolder + "/")) {
                    return col;
                }
            }
            return null;
        }

        function renderFrontMatterForm(fm, path) {
            const container = document.getElementById('fm-container');
            container.innerHTML = '<div style="color:#aaa; font-weight:bold; margin-bottom:10px;">Front Matter</div>';
            
            const collection = getCollectionForPath(path);
            const definedFields = collection ? collection.fields : [];
            const processedKeys = new Set();

            definedFields.forEach(field => {
                if (field.name === 'body') return;
                
                const val = fm[field.name];
                renderField(container, field, val);
                processedKeys.add(field.name);
            });

            for (const [key, value] of Object.entries(fm)) {
                if (!processedKeys.has(key)) {
                    let widget = 'string';
                    if (typeof value === 'boolean') widget = 'boolean';
                    else if (Array.isArray(value)) widget = 'list';
                    
                    renderField(container, { name: key, label: key + " (Extra)", widget: widget }, value);
                }
            }
        }

        function renderField(container, field, value) {
            const div = document.createElement('div');
            div.className = 'fm-field';
            
            const label = document.createElement('label');
            label.className = 'fm-label';
            label.textContent = field.label || field.name;
            div.appendChild(label);

            if (field.widget === 'datetime') {
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.gap = '5px';

                const input = createInputForWidget(field, value);
                input.style.flex = '1';
                
                const nowBtn = document.createElement('button');
                nowBtn.textContent = 'Now';
                nowBtn.className = 'action-btn'; 
                nowBtn.style.background = '#444';
                nowBtn.style.padding = '4px 8px';
                nowBtn.style.fontSize = '12px';
                nowBtn.onclick = () => {
                    const d = new Date();
                    const pad = (n) => n < 10 ? '0'+n : n;
                    const localIso = d.getFullYear() + '-' + 
                                   pad(d.getMonth()+1) + '-' + 
                                   pad(d.getDate()) + 'T' + 
                                   pad(d.getHours()) + ':' + 
                                   pad(d.getMinutes());
                    input.value = localIso;
                };

                wrapper.appendChild(input);
                wrapper.appendChild(nowBtn);
                div.appendChild(wrapper);
            } else {
                const input = createInputForWidget(field, value);
                div.appendChild(input);
            }
            
            container.appendChild(div);
        }

        function createInputForWidget(field, value) {
            let input;

            if (field.widget === 'boolean') {
                input = document.createElement('input');
                input.type = 'checkbox';
                input.className = 'fm-checkbox';
                input.checked = value === true;
                input.dataset.key = field.name;
                input.dataset.widget = 'boolean';
                
            } else if (field.widget === 'datetime') {
                input = document.createElement('input');
                input.type = 'datetime-local';
                input.className = 'fm-input';
                if (value) {
                    try {
                        const d = new Date(value);
                        const pad = (n) => n < 10 ? '0'+n : n;
                        const localIso = d.getFullYear() + '-' + 
                                       pad(d.getMonth()+1) + '-' + 
                                       pad(d.getDate()) + 'T' + 
                                       pad(d.getHours()) + ':' + 
                                       pad(d.getMinutes());
                        input.value = localIso;
                    } catch(e) {
                        input.value = value;
                    }
                }
                input.dataset.key = field.name;
                input.dataset.widget = 'datetime';

            } else if (field.widget === 'list') {
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'fm-input';
                input.placeholder = "Comma separated values";
                if (Array.isArray(value)) {
                    input.value = value.join(', ');
                } else if (value) {
                    input.value = String(value);
                }
                input.dataset.key = field.name;
                input.dataset.widget = 'list';

            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'fm-input';
                input.value = (value === null || value === undefined) ? (field.default || '') : value;
                input.dataset.key = field.name;
                input.dataset.widget = 'string';
            }
            return input;
        }

        function collectFrontMatter() {
            if (!currentData || !currentData.frontmatter) return null;
            
            const fm = {};
            const inputs = document.querySelectorAll('#fm-container input');
            
            inputs.forEach(input => {
                const key = input.dataset.key;
                const widget = input.dataset.widget;
                
                if (widget === 'boolean') {
                    fm[key] = input.checked;
                } else if (widget === 'list') {
                    const val = input.value.trim();
                    if (val === "") {
                         fm[key] = [];
                    } else {
                         fm[key] = val.split(',').map(s => s.trim()).filter(s => s !== "");
                    }
                } else if (widget === 'datetime') {
                    if (input.value) {
                        const d = new Date(input.value);
                        const pad = (n) => (n < 10 ? '0' : '') + n;
                        const tzo = -d.getTimezoneOffset();
                        const dif = tzo >= 0 ? '+' : '-';
                        const offH = pad(Math.floor(Math.abs(tzo) / 60));
                        const offM = pad(Math.abs(tzo) % 60);
                        
                        fm[key] = d.getFullYear() + '-' + 
                                  pad(d.getMonth() + 1) + '-' + 
                                  pad(d.getDate()) + 'T' + 
                                  pad(d.getHours()) + ':' + 
                                  pad(d.getMinutes()) + ':' + 
                                  pad(d.getSeconds()) + 
                                  dif + offH + ':' + offM;
                    } else {
                        fm[key] = null;
                    }
                } else {
                    fm[key] = input.value;
                }
            });
            return fm;
        }

        function getPayload() {
            const payload = { path: currentPath };
            const fm = collectFrontMatter();
            if (fm) {
                payload.frontmatter = fm;
                payload.body = document.getElementById('editor').value;
                payload.format = currentData.format || 'yaml';
            } else {
                payload.content = document.getElementById('editor').value;
            }
            return payload;
        }

        async function saveFile() {
            if(!currentPath) return alert("No file selected");
            
            const btn = document.querySelector('button[onclick="saveFile()"]');
            const originalText = btn.textContent;
            btn.textContent = "Saving...";

            await fetch('/api/article', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(getPayload())
            });
            
            btn.textContent = originalText;
        }

        async function resetChanges() {
            if(!currentPath) return;
            if(!confirm("Are you sure you want to discard all changes?")) return;
            await loadFile(currentPath);
        }

        async function showDiff() {
            if(!currentPath) return;
            const payload = getPayload();
            
            const res = await fetch('/api/diff', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            const body = document.getElementById('modal-body');
            // Basic syntax highlight for diff
            let html = data.diff.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            html = html.split('\n').map(line => {
                if(line.startsWith('+')) return `<span class="diff-added">${line}</span>`;
                if(line.startsWith('-')) return `<span class="diff-removed">${line}</span>`;
                return line;
            }).join('\n');
            
            body.innerHTML = html || "No differences";
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        async function runBuild() {
            const btn = document.querySelector('button[onclick="runBuild()"]');
            btn.textContent = "Building...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/build', { method: 'POST' });
                const data = await res.json();
                
                if (data.status === 'ok') {
                    const frame = document.getElementById('preview-frame');
                    let previewPath = currentPath.replace(/\.md$/, ""); 
                    
                    if (previewPath.endsWith("/index") || previewPath.endsWith("/_index")) {
                        previewPath = previewPath.substring(0, previewPath.lastIndexOf("/"));
                    } else if (previewPath === "index" || previewPath === "_index") {
                        previewPath = "";
                    }

                    const targetUrl = "/preview/" + previewPath + (previewPath ? "/" : "");
                    frame.src = targetUrl + "?t=" + Date.now();
                    switchTab('preview', document.querySelectorAll('nav button')[2]);
                } else {
                    alert("Build Error:\n" + data.log);
                }
            } catch(e) {
                alert("Network Error");
            } finally {
                btn.textContent = "Build";
                btn.disabled = false;
            }
        }

        async function runSync() {
            if(!confirm("GitHub„Åã„ÇâÊúÄÊñ∞„ÅÆÁä∂ÊÖã„ÇíÂèñÂæó„Åó„Åæ„Åô„ÅãÔºü\nÔºà„É≠„Éº„Ç´„É´„ÅÆÊú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„ÅØÊ≥®ÊÑè„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ")) return; 
            
            const btn = document.querySelector('button[onclick="runSync()"]');
            const originalText = btn.textContent;
            btn.textContent = "Syncing...";
            
            try {
                const res = await fetch('/api/sync', { method: 'POST' });
                const data = await res.json();
                if(data.status === 'ok') {
                    alert("Sync Complete!\n" + data.log);
                    fetchFiles(); 
                } else {
                    alert("Sync Error:\n" + data.log);
                }
            } catch(e) {
                alert("Network Error");
            } finally {
                btn.textContent = originalText;
            }
        }

        async function runPublish() {
            if(!confirm("„Åì„ÅÆË®ò‰∫ã„ÅÆÂ§âÊõ¥„ÇíGitHub„Å´Push„Åó„Å¶ÂÖ¨Èñã„Åó„Åæ„Åô„ÅãÔºü")) return;

            const btn = document.querySelector('button[onclick="runPublish()"]');
            btn.textContent = "Pushing...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/publish', { method: 'POST' });
                const data = await res.json();
                if(data.status === 'ok') {
                    alert("Published Successfully! üöÄ\nCloudflare Pages will deploy shortly.");
                } else {
                    alert("Publish Error:\n" + data.log);
                }
            } catch(e) {
                alert("Network Error");
            } finally {
                btn.textContent = "Publish";
                btn.disabled = false;
            }
        }

        async function createNewFile() {
            let path = prompt("Enter file path (e.g., posts/my-new-post.md):", "posts/");
            if (!path) return;

            if (!path.endsWith(".md") && !path.endsWith(".markdown")) {
                if(!confirm("Filename does not end with .md. Continue?")) return;
            }

            const content = "---\ntitle: New Post\ndraft: true\n---\n";

            try {
                const res = await fetch('/api/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ path: path, content: content })
                });

                if (res.ok) {
                    await fetchFiles(); 
                    await loadFile(path); 
                } else {
                    const data = await res.json();
                    alert("Create Failed: " + data.error);
                }
            } catch(e) {
                alert("Network Error");
            }
        }
    </script>
</body>
</html>